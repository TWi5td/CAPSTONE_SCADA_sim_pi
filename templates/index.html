<!DOCTYPE html>
<html>
<head>
    <title>IED Simulator - Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        header h1 {
            color: #1a365d;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        header p {
            color: #666;
            font-size: 14px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: #1a365d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .nav-btn:hover {
            background: #2d4a7c;
        }
        
        .nav-btn.secondary {
            background: #4a5568;
        }
        
        .nav-btn.secondary:hover {
            background: #718096;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: #1a365d;
        }
        
        .stat-value.success {
            color: #276749;
        }
        
        .stat-value.info {
            color: #2b6cb0;
        }
        
        .section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #1a365d;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a365d;
            font-weight: 600;
        }
        
        .connection-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 4px;
            border-left: 4px solid #1a365d;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #1a365d;
            font-family: 'Courier New', monospace;
        }
        
        .register-grid {
            display: grid;
            gap: 15px;
        }
        
        .register-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .register-item:hover {
            background: #edf2f7;
        }
        
        .register-name {
            flex: 1;
            font-weight: 600;
            color: #2d3748;
        }
        
        .register-value {
            min-width: 80px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #1a365d;
            margin: 0 15px;
        }
        
        .register-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="number"] {
            width: 100px;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #1a365d;
        }
        
        button {
            padding: 8px 16px;
            background: #1a365d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #2d4a7c;
        }
        
        .toggle-btn {
            min-width: 80px;
            background: #276749;
        }
        
        .toggle-btn:hover {
            background: #2f855a;
        }
        
        .toggle-btn.active {
            background: #c53030;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            border: 2px solid #cbd5e0;
        }
        
        .status-on {
            background: #48bb78;
            border-color: #276749;
        }
        
        .status-off {
            background: #a0aec0;
            border-color: #718096;
        }
        
        .activity-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f7fafc;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .activity-item {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #1a365d;
        }
        
        .timestamp {
            color: #666;
            margin-right: 10px;
        }
        
        .change-type {
            font-weight: bold;
            color: #1a365d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SCADA IED Simulator - Dashboard</h1>
            <p>Real-time monitoring and control interface for Modbus TCP simulation</p>
            <div class="nav-buttons">
                <a href="/" class="nav-btn">Dashboard</a>
                <a href="/simulation" class="nav-btn">Live Simulation</a>
                <a href="/variables" class="nav-btn">Custom Variables</a>
                <button class="nav-btn secondary" onclick="exportConfig()">Export Config</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">System Uptime</div>
                <div class="stat-value success" id="uptime">00:00:00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Requests</div>
                <div class="stat-value info" id="total-requests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Modbus Status</div>
                <div class="stat-value success" id="modbus-status">Running</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Request</div>
                <div class="stat-value" id="last-request">Never</div>
            </div>
        </div>

        <div class="section">
            <h2>Connection Information</h2>
            <div class="connection-info">
                <div class="info-item">
                    <div class="info-label">Protocol</div>
                    <div class="info-value">Modbus TCP</div>
                </div>
                <div class="info-item">
                    <div class="info-label">IP Address</div>
                    <div class="info-value" id="server-ip">0.0.0.0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Port</div>
                    <div class="info-value" id="server-port">5002</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Unit ID</div>
                    <div class="info-value" id="unit-id">254</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Coils (Digital Outputs - Read/Write)</h2>
            <div class="register-grid">
                <div class="register-item">
                    <span class="register-name">COIL_00000 (Address: 0)</span>
                    <span class="register-value" id="coil-0">0</span>
                    <span class="status-indicator status-off" id="coil-0-led"></span>
                    <div class="register-controls">
                        <button class="toggle-btn" onclick="toggleCoil(0)">Toggle</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Discrete Inputs (Digital Inputs - Read Only)</h2>
            <div class="register-grid">
                <div class="register-item">
                    <span class="register-name">DI_00000 (Address: 0)</span>
                    <span class="register-value" id="di-0">0</span>
                    <span class="status-indicator status-off" id="di-0-led"></span>
                    <div class="register-controls">
                        <button class="toggle-btn" onclick="toggleDiscreteInput(0)">Toggle</button>
                    </div>
                </div>
                <div class="register-item">
                    <span class="register-name">DI_00001 (Address: 1)</span>
                    <span class="register-value" id="di-1">0</span>
                    <span class="status-indicator status-off" id="di-1-led"></span>
                    <div class="register-controls">
                        <button class="toggle-btn" onclick="toggleDiscreteInput(1)">Toggle</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Holding Registers (Analog Outputs - Read/Write)</h2>
            <div class="register-grid">
                <div class="register-item">
                    <span class="register-name">SIM_AO_00 (Address: 0)</span>
                    <span class="register-value" id="hr-0">0</span>
                    <div class="register-controls">
                        <input type="number" id="hr-0-input" value="0" min="-32768" max="32767">
                        <button onclick="setHoldingRegister(0)">Set</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Input Registers (Analog Inputs - Read Only)</h2>
            <div class="register-grid">
                <div class="register-item">
                    <span class="register-name">SIM_AI_00 (Address: 0)</span>
                    <span class="register-value" id="ir-0">100</span>
                    <div class="register-controls">
                        <input type="number" id="ir-0-input" value="100" min="-32768" max="32767">
                        <button onclick="setInputRegister(0)">Set</button>
                    </div>
                </div>
                <div class="register-item">
                    <span class="register-name">SIM_AI_01 (Address: 1)</span>
                    <span class="register-value" id="ir-1">200</span>
                    <div class="register-controls">
                        <input type="number" id="ir-1-input" value="200" min="-32768" max="32767">
                        <button onclick="setInputRegister(1)">Set</button>
                    </div>
                </div>
                <div class="register-item">
                    <span class="register-name">IREG_00002 (Address: 2)</span>
                    <span class="register-value" id="ir-2">0</span>
                    <div class="register-controls">
                        <input type="number" id="ir-2-input" value="0" min="-32768" max="32767">
                        <button onclick="setInputRegister(2)">Set</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Recent Activity</h2>
            <div class="activity-log" id="activity-log">
                <div class="activity-item">
                    <span class="timestamp">System started</span>
                    <span class="change-type">No activity yet</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateSystemStatus() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    const uptime = Math.floor(data.system.uptime_seconds);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = uptime % 60;
                    document.getElementById('uptime').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('total-requests').textContent = data.system.total_requests;
                    document.getElementById('modbus-status').textContent = 
                        data.system.modbus_running ? 'Running' : 'Stopped';
                    
                    if (data.system.last_request) {
                        const lastReq = new Date(data.system.last_request);
                        document.getElementById('last-request').textContent = 
                            lastReq.toLocaleTimeString();
                    }
                    
                    document.getElementById('server-ip').textContent = data.modbus.ip;
                    document.getElementById('server-port').textContent = data.modbus.port;
                    document.getElementById('unit-id').textContent = data.modbus.address;
                    
                    if (data.recent_changes && data.recent_changes.length > 0) {
                        const logHtml = data.recent_changes.reverse().map(change => {
                            const time = new Date(change.timestamp).toLocaleTimeString();
                            return `
                                <div class="activity-item">
                                    <span class="timestamp">${time}</span>
                                    <span class="change-type">${change.type}</span>
                                    Address ${change.address}: ${change.old_value} -> ${change.new_value}
                                </div>
                            `;
                        }).join('');
                        document.getElementById('activity-log').innerHTML = logHtml;
                    }
                });
        }

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('coil-0').textContent = data.coils.COIL_00000;
                    updateLED('coil-0-led', data.coils.COIL_00000);
                    
                    document.getElementById('di-0').textContent = data.discrete_inputs.DI_00000;
                    updateLED('di-0-led', data.discrete_inputs.DI_00000);
                    document.getElementById('di-1').textContent = data.discrete_inputs.DI_00001;
                    updateLED('di-1-led', data.discrete_inputs.DI_00001);
                    
                    document.getElementById('hr-0').textContent = data.holding_registers.HR_00000;
                    
                    document.getElementById('ir-0').textContent = data.input_registers.IR_00000;
                    document.getElementById('ir-1').textContent = data.input_registers.IR_00001;
                    document.getElementById('ir-2').textContent = data.input_registers.IR_00002;
                });
        }

        function updateLED(elementId, value) {
            const led = document.getElementById(elementId);
            if (value) {
                led.classList.remove('status-off');
                led.classList.add('status-on');
            } else {
                led.classList.remove('status-on');
                led.classList.add('status-off');
            }
        }

        function toggleCoil(address) {
            const currentValue = parseInt(document.getElementById(`coil-${address}`).textContent);
            const newValue = currentValue ? 0 : 1;
            
            fetch('/api/set_coil', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({address: address, value: newValue})
            }).then(() => {
                updateStatus();
                updateSystemStatus();
            });
        }

        function toggleDiscreteInput(address) {
            const currentValue = parseInt(document.getElementById(`di-${address}`).textContent);
            const newValue = currentValue ? 0 : 1;
            
            fetch('/api/set_discrete_input', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({address: address, value: newValue})
            }).then(() => {
                updateStatus();
                updateSystemStatus();
            });
        }

        function setHoldingRegister(address) {
            const value = parseInt(document.getElementById(`hr-${address}-input`).value);
            
            fetch('/api/set_holding_register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({address: address, value: value})
            }).then(() => {
                updateStatus();
                updateSystemStatus();
            });
        }

        function setInputRegister(address) {
            const value = parseInt(document.getElementById(`ir-${address}-input`).value);
            
            fetch('/api/set_input_register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({address: address, value: value})
            }).then(() => {
                updateStatus();
                updateSystemStatus();
            });
        }

        function exportConfig() {
            fetch('/api/export_config')
                .then(response => response.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `scada_config_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
        }

        setInterval(updateStatus, 1000);
        setInterval(updateSystemStatus, 1000);
        updateStatus();
        updateSystemStatus();
    </script>
</body>
</html>
