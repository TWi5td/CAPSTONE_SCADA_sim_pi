<!DOCTYPE html>
<html>
<head>
    <title>Power Industry Register Map</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        header h1 {
            color: #1a365d;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        header p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: #1a365d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .nav-btn:hover {
            background: #2d4a7c;
        }
        
        .nav-btn.success {
            background: #276749;
        }
        
        .nav-btn.success:hover {
            background: #2f855a;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 500;
            color: #4a5568;
            font-size: 13px;
        }
        
        input[type="text"],
        select {
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #1a365d;
        }
        
        .stats-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1a365d;
            display: block;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        
        .section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #1a365d;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a365d;
            font-weight: 600;
            font-size: 20px;
        }
        
        .register-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .register-table thead {
            background: #1a365d;
            color: white;
        }
        
        .register-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .register-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .register-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .register-name {
            font-weight: 600;
            color: #1a365d;
            font-family: 'Courier New', monospace;
        }
        
        .register-address {
            font-weight: bold;
            color: #2d3748;
            font-family: 'Courier New', monospace;
        }
        
        .register-value {
            font-family: 'Courier New', monospace;
            color: #2d3748;
        }
        
        .register-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .type-input {
            background: #e6fffa;
            color: #234e52;
        }
        
        .type-holding {
            background: #fef5e7;
            color: #7d6608;
        }
        
        .type-discrete {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .type-coil {
            background: #ffe4e6;
            color: #9f1239;
        }
        
        .category-section {
            margin-bottom: 30px;
        }
        
        .category-header {
            background: #f7fafc;
            padding: 15px 20px;
            border-left: 4px solid #1a365d;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a365d;
        }
        
        .category-count {
            font-size: 13px;
            color: #666;
            background: white;
            padding: 4px 12px;
            border-radius: 4px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .access-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .access-ro {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .access-rw {
            background: #c6f6d5;
            color: #276749;
        }

        .export-options {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }
            
            .register-table {
                font-size: 11px;
            }
            
            .register-table th,
            .register-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Power Industry Register Map</h1>
            <p>Complete Modbus register reference for the Power Industry IED Simulator with 260+ pre-configured variables</p>
            <div class="nav-buttons">
                <a href="/" class="nav-btn">Dashboard</a>
                <a href="/simulation" class="nav-btn">Live Simulation</a>
                <button onclick="exportToCSV()" class="nav-btn success">Export to CSV</button>
                <button onclick="exportToJSON()" class="nav-btn success">Export to JSON</button>
            </div>
        </header>

        <!-- Statistics Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span id="total-count" class="stat-value">0</span>
                <span class="stat-label">Total Variables</span>
            </div>
            <div class="stat-item">
                <span id="input-reg-count" class="stat-value">0</span>
                <span class="stat-label">Input Registers</span>
            </div>
            <div class="stat-item">
                <span id="holding-reg-count" class="stat-value">0</span>
                <span class="stat-label">Holding Registers</span>
            </div>
            <div class="stat-item">
                <span id="discrete-count" class="stat-value">0</span>
                <span class="stat-label">Discrete Inputs</span>
            </div>
            <div class="stat-item">
                <span id="coil-count" class="stat-value">0</span>
                <span class="stat-label">Coils</span>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="controls">
            <div class="control-group">
                <label>Search</label>
                <input type="text" id="search-input" placeholder="Search by name, address, or description..." oninput="filterRegisters()">
            </div>
            
            <div class="control-group">
                <label>Register Type</label>
                <select id="type-filter" onchange="filterRegisters()">
                    <option value="all">All Types</option>
                    <option value="input_registers">Input Registers (Read Only)</option>
                    <option value="holding_registers">Holding Registers (Read/Write)</option>
                    <option value="discrete_inputs">Discrete Inputs (Read Only)</option>
                    <option value="coils">Coils (Read/Write)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Category</label>
                <select id="category-filter" onchange="filterRegisters()">
                    <option value="all">All Categories</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button class="nav-btn" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>

        <!-- Register Map Display -->
        <div class="section">
            <h2>Register Map</h2>
            <div id="register-display"></div>
        </div>
    </div>

    <script>
        let registerMap = null;
        let categories = new Set();

        // Fetch the register map from the API
        async function loadRegisterMap() {
            try {
                const response = await fetch('/api/register_map');
                registerMap = await response.json();
                
                // Extract categories
                categories.clear();
                Object.values(registerMap).forEach(typeMap => {
                    Object.values(typeMap).forEach(reg => {
                        if (reg.category) categories.add(reg.category);
                    });
                });
                
                // Populate category filter
                const categoryFilter = document.getElementById('category-filter');
                Array.from(categories).sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
                
                // Update statistics
                updateStatistics();
                
                // Display registers
                displayRegisters();
            } catch (error) {
                console.error('Error loading register map:', error);
                document.getElementById('register-display').innerHTML = 
                    '<div class="no-results">Error loading register map. Please ensure the server is running.</div>';
            }
        }

        function updateStatistics() {
            if (!registerMap) return;
            
            const inputCount = Object.keys(registerMap.input_registers || {}).length;
            const holdingCount = Object.keys(registerMap.holding_registers || {}).length;
            const discreteCount = Object.keys(registerMap.discrete_inputs || {}).length;
            const coilCount = Object.keys(registerMap.coils || {}).length;
            const total = inputCount + holdingCount + discreteCount + coilCount;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('input-reg-count').textContent = inputCount;
            document.getElementById('holding-reg-count').textContent = holdingCount;
            document.getElementById('discrete-count').textContent = discreteCount;
            document.getElementById('coil-count').textContent = coilCount;
        }

        function displayRegisters() {
            if (!registerMap) return;
            
            const typeFilter = document.getElementById('type-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let html = '';
            let totalDisplayed = 0;
            
            const registerTypes = {
                'input_registers': { name: 'Input Registers', access: 'Read Only', badge: 'type-input' },
                'holding_registers': { name: 'Holding Registers', access: 'Read/Write', badge: 'type-holding' },
                'discrete_inputs': { name: 'Discrete Inputs', access: 'Read Only', badge: 'type-discrete' },
                'coils': { name: 'Coils', access: 'Read/Write', badge: 'type-coil' }
            };
            
            Object.entries(registerTypes).forEach(([type, info]) => {
                if (typeFilter !== 'all' && typeFilter !== type) return;
                if (!registerMap[type]) return;
                
                // Group by category
                const categorized = {};
                Object.entries(registerMap[type]).forEach(([address, reg]) => {
                    const cat = reg.category || 'Uncategorized';
                    if (!categorized[cat]) categorized[cat] = [];
                    categorized[cat].push({ address: parseInt(address), ...reg });
                });
                
                Object.entries(categorized).sort().forEach(([category, registers]) => {
                    if (categoryFilter !== 'all' && categoryFilter !== category) return;
                    
                    // Filter and sort registers
                    let filteredRegs = registers.filter(reg => {
                        if (!searchTerm) return true;
                        return reg.name.toLowerCase().includes(searchTerm) ||
                               reg.description.toLowerCase().includes(searchTerm) ||
                               reg.address.toString().includes(searchTerm) ||
                               (reg.unit && reg.unit.toLowerCase().includes(searchTerm));
                    });
                    
                    if (filteredRegs.length === 0) return;
                    
                    filteredRegs.sort((a, b) => a.address - b.address);
                    totalDisplayed += filteredRegs.length;
                    
                    html += `
                        <div class="category-section">
                            <div class="category-header">
                                <div>
                                    <span class="register-type-badge ${info.badge}">${info.name}</span>
                                    <span class="category-title"> - ${category}</span>
                                </div>
                                <span class="category-count">${filteredRegs.length} variables</span>
                            </div>
                            <table class="register-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Address</th>
                                        <th style="width: 200px;">Variable Name</th>
                                        <th>Description</th>
                                        <th style="width: 80px;">Unit</th>
                                        <th style="width: 100px;">Scale Factor</th>
                                        <th style="width: 100px;">Default Value</th>
                                        <th style="width: 80px;">Access</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    filteredRegs.forEach(reg => {
                        const scaledDefault = reg.default != null && reg.scale ? 
                            (reg.default * reg.scale).toFixed(reg.scale < 1 ? 2 : 1) : 
                            (reg.default || 0);
                        
                        const accessBadge = info.access === 'Read Only' ? 
                            '<span class="access-badge access-ro">RO</span>' : 
                            '<span class="access-badge access-rw">R/W</span>';
                        
                        html += `
                            <tr>
                                <td><span class="register-address">${reg.address}</span></td>
                                <td><span class="register-name">${reg.name}</span></td>
                                <td>${reg.description}</td>
                                <td>${reg.unit || '-'}</td>
                                <td>${reg.scale != null ? reg.scale : '-'}</td>
                                <td><span class="register-value">${scaledDefault} ${reg.unit || ''}</span></td>
                                <td>${accessBadge}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
            });
            
            if (totalDisplayed === 0) {
                html = '<div class="no-results">No registers match your search criteria.</div>';
            }
            
            document.getElementById('register-display').innerHTML = html;
        }

        function filterRegisters() {
            displayRegisters();
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('type-filter').value = 'all';
            document.getElementById('category-filter').value = 'all';
            displayRegisters();
        }

        function exportToCSV() {
            if (!registerMap) return;
            
            let csv = 'Register Type,Category,Address,Variable Name,Description,Unit,Scale Factor,Default Value,Access\n';
            
            const registerTypes = {
                'input_registers': { name: 'Input Register', access: 'Read Only' },
                'holding_registers': { name: 'Holding Register', access: 'Read/Write' },
                'discrete_inputs': { name: 'Discrete Input', access: 'Read Only' },
                'coils': { name: 'Coil', access: 'Read/Write' }
            };
            
            Object.entries(registerTypes).forEach(([type, info]) => {
                if (!registerMap[type]) return;
                
                Object.entries(registerMap[type]).forEach(([address, reg]) => {
                    const scaledDefault = reg.default != null && reg.scale ? 
                        (reg.default * reg.scale).toFixed(reg.scale < 1 ? 2 : 1) : 
                        (reg.default || 0);
                    
                    csv += `"${info.name}","${reg.category || 'Uncategorized'}",${address},"${reg.name}","${reg.description}","${reg.unit || ''}","${reg.scale || ''}","${scaledDefault}","${info.access}"\n`;
                });
            });
            
            downloadFile(csv, 'power_industry_register_map.csv', 'text/csv');
        }

        function exportToJSON() {
            if (!registerMap) return;
            
            const json = JSON.stringify(registerMap, null, 2);
            downloadFile(json, 'power_industry_register_map.json', 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], {type: mimeType});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Load register map on page load
        loadRegisterMap();
    </script>
</body>
</html>
